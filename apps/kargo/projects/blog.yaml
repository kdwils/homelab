apiVersion: kargo.akuity.io/v1alpha1
kind: Project
metadata:
  name: blog
---
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: blog
spec:
  promotionPolicies:
    - stageSelector:
        name: blog-dev
      autoPromotionEnabled: true
    - stageSelector:
        name: blog-prod
      autoPromotionEnabled: false
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: blog
spec:
  subscriptions:
    - image:
        repoURL: ghcr.io/kdwils/blog
        semverConstraint: ^1.0.0
    - git:
        repoURL: https://github.com/kdwils/blog-deploy.git
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: blog-prod
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - blog-dev
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
      steps:
        - task:
            name: kustomize-image-promote
            kind: ClusterPromotionTask
          config:
            gitRepo: ${{ vars.gitRepo }}
            imageRepo: ${{ vars.imageRepo }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: blog-dev
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
      steps:
        - task:
            name: kustomize-image-promote
            kind: ClusterPromotionTask
          config:
            gitRepo: ${{ vars.gitRepo }}
            imageRepo: ${{ vars.imageRepo }}
