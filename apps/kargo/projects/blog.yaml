apiVersion: kargo.akuity.io/v1alpha1
kind: Project
metadata:
  name: blog
---
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: blog
  namespace: blog
spec:
  promotionPolicies:
    - stageSelector:
        name: update-config
      autoPromotionEnabled: true
    - stageSelector:
        name: dev
      autoPromotionEnabled: true
    - stageSelector:
        name: prod
      autoPromotionEnabled: false
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: blog-deploy
  namespace: blog
spec:
  subscriptions:
    - image:
        repoURL: ghcr.io/kdwils/blog
        semverConstraint: ^1.0.0
    - chart:
        repoURL: https://kdwils.github.io/helm-charts
        name: homelab-chart
    - git:
        repoURL: https://github.com/kdwils/blog-deploy.git
        branch: main
        includePaths:
          - glob:environments/**
          - glob:charts/**
        excludePaths:
          - glob:rendered/**
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: helm-charts
  namespace: blog
spec:
  subscriptions:
    - chart:
        repoURL: https://kdwils.github.io/helm-charts
        name: homelab-chart
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: images
  namespace: blog
spec:
  subscriptions:
    - image:
        repoURL: ghcr.io/kdwils/blog
        semverConstraint: ^1.0.0
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: update-helm-charts
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: helm-charts
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: chartPath
          value: charts/blog-deploy
        - name: sourceBranch
          value: main
        - name: targetBranch
          value: stage/dev
      steps:
        - task:
            name: helm-update
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: update-image
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: images
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: chartPath
          value: charts/blog-deploy
        - name: sourceBranch
          value: main
        - name: targetBranch
          value: stage/dev
      steps:
        - task:
            name: update-image
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: render-manifests
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog-deploy
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: chartPath
          value: charts/blog-deploy
        - name: sourceBranch
          value: main
        - name: targetBranch
          value: stage/dev
      steps:
        - task:
            name: helm-render
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: dev
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - render-manifests
  promotionTemplate:
    spec:
      vars:
        - name: appName
          value: blog-dev
        - name: appNamespace
          value: argocd
      steps:
        - task:
            name: argocd-sync
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: prod
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - dev
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: sourceBranch
          value: stage/dev
        - name: targetBranch
          value: stage/prod
        - name: appName
          value: blog-prod
        - name: appNamespace
          value: argocd
      steps:
        - task:
            name: promote-branch-with-approval
            kind: ClusterPromotionTask
        - task:
            name: argocd-sync
            kind: ClusterPromotionTask
