apiVersion: kargo.akuity.io/v1alpha1
kind: Project
metadata:
  name: blog
---
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: blog
  namespace: blog
spec:
  promotionPolicies:
    - stageSelector:
        name: main
      autoPromotionEnabled: true
    - stageSelector:
        name: dev
      autoPromotionEnabled: true
    - stageSelector:
        name: prod
      autoPromotionEnabled: false
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: blog
  namespace: blog
spec:
  subscriptions:
    - image:
        repoURL: ghcr.io/kdwils/blog
        semverConstraint: ^1.0.0
        strictSemvers: false
    - git:
        repoURL: https://github.com/kdwils/homelab.git
        branch: main
        includePaths:
          - glob:apps/bluesky/environments/**
          - glob:charts/homelab/**
        excludePaths:
          - glob:apps/blog/rendered/**
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: main
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/homelab
        - name: targetBranch
          value: main
        - name: warehouse
          value: blog
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: imageTagYamlPath
          value: blog.deployment.image.tag
      steps:
        - uses: git-clone
          as: clone-main
          config:
            repoURL: ${{ vars.gitRepo }}
            checkout:
              - branch: ${{ vars.targetBranch }}
                path: ./repo
        - uses: yaml-update
          as: update-dev
          config:
            path: ./repo/apps/blog/environments/dev/homelab.yaml
            updates:
              - key: ${{ vars.imageTagYamlPath }}
                value: ${{ imageFrom(vars.imageRepo, warehouse(vars.warehouse)).Tag }}
        - uses: yaml-update
          as: update-prod
          config:
            path: ./repo/apps/blog/environments/prod/homelab.yaml
            updates:
              - key: ${{ vars.imageTagYamlPath }}
                value: ${{ imageFrom(vars.imageRepo, warehouse(vars.warehouse)).Tag }}
        - uses: git-commit
          as: commit-updates
          config:
            path: ./repo
            message: |
              Update blog image across all environments
              - Image: ${{ imageFrom(vars.imageRepo, warehouse(vars.warehouse)).Tag }}
              - Environments: dev, prod
        - uses: git-push
          as: push-feature-branch
          config:
            path: ./repo
            generateTargetBranch: true
        - uses: git-open-pr
          as: open-pr-main
          continueOnError: true
          config:
            repoURL: ${{ vars.gitRepo }}
            sourceBranch: ${{ outputs['push-feature-branch'].branch }}
            targetBranch: ${{ vars.targetBranch }}
            createTargetBranch: false
            title: "Update blog image across environments"
            description: |
              ## Updates
              - **Image:** `${{ imageFrom(vars.imageRepo, warehouse(vars.warehouse)).Tag }}`
              - **Environments:** dev, prod
              Updated via Kargo promotion from warehouse: ${{ vars.warehouse }}
        - uses: git-wait-for-pr
          as: wait-pr-approval
          if: ${{ status('open-pr-main') == 'Succeeded' }}
          config:
            repoURL: ${{ vars.gitRepo }}
            prNumber: ${{ outputs['open-pr-main'].pr.id }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: dev
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - main
  promotionTemplate:
    spec:
      vars:
        - name: targetBranch
          value: apps/blog/dev
        - name: projectName
          value: blog
        - name: environmentsPath
          value: apps/blog/environments/dev
        - name: valuesFilePath
          value: apps/blog/environments/dev/homelab.yaml
        - name: appName
          value: blog-dev
        - name: namespace
          value: blog
      steps:
        - task:
            name: render-and-pr-helm
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: prod
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - dev
  promotionTemplate:
    spec:
      vars:
        - name: targetBranch
          value: apps/blog/prod
        - name: projectName
          value: blog
        - name: environmentsPath
          value: apps/blog/environments/prod
        - name: valuesFilePath
          value: apps/blog/environments/prod/homelab.yaml
        - name: appName
          value: blog-prod
        - name: namespace
          value: blog
      steps:
        - task:
            name: render-and-pr-helm
            kind: ClusterPromotionTask
