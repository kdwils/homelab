apiVersion: kargo.akuity.io/v1alpha1
kind: Project
metadata:
  name: blog
---
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: blog
  namespace: blog
spec:
  promotionPolicies:
    - stageSelector:
        name: render
      autoPromotionEnabled: true
    - stageSelector:
        name: dev
      autoPromotionEnabled: true
    - stageSelector:
        name: prod
      autoPromotionEnabled: false
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: blog
  namespace: blog
spec:
  subscriptions:
    - image:
        repoURL: ghcr.io/kdwils/blog
        semverConstraint: ^1.0.0
    - git:
        repoURL: https://github.com/kdwils/blog-deploy.git
        branch: main
        excludePaths:
          - rendered/**
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: render
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: targetRevision
          value: main
      steps:
        - task:
            name: git-clone
            kind: ClusterPromotionTask
        - task:
            name: render-kustomize
            kind: ClusterPromotionTask
          vars:
            - name: overlayPath
              value: overlays/dev
            - name: environment
              value: dev
        - task:
            name: render-kustomize
            kind: ClusterPromotionTask
          vars:
            - name: overlayPath
              value: overlays/prod
            - name: environment
              value: prod
        - task:
            name: git-push
            kind: ClusterPromotionTask
          vars:
            - name: commitMessage
              value: "Render manifests for ${{ imageFrom(vars.imageRepo).Tag }}"
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: dev
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - render
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: sourcePath
          value: rendered/dev
        - name: targetBranch
          value: stage/dev
        - name: appName
          value: blog-dev
      steps:
        - task:
            name: promote-with-auto-merge
            kind: ClusterPromotionTask
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: prod
  namespace: blog
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: blog
      sources:
        stages:
          - dev
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/blog-deploy
        - name: imageRepo
          value: ghcr.io/kdwils/blog
        - name: sourcePath
          value: rendered/prod
        - name: targetBranch
          value: stage/prod
        - name: appName
          value: blog-prod
      steps:
        - task:
            name: promote-with-manual-approval
            kind: ClusterPromotionTask
