apiVersion: kargo.akuity.io/v1alpha1
kind: Project
metadata:
  name: argocd
  annotations:
    kargo.akuity.io/keep-namespace: "true"
---
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: argocd
  namespace: argocd
spec:
  promotionPolicies:
    - stageSelector:
        name: main
      autoPromotionEnabled: false
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Warehouse
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: "1h0m0s"
  subscriptions:
    - chart:
        repoURL: https://argoproj.github.io/argo-helm
        name: argo-cd
    - chart:
        repoURL: https://kdwils.github.io/helm-charts
        name: homelab-chart
    - git:
        repoURL: https://github.com/kdwils/homelab.git
        branch: main
        includePaths:
          - glob:infra/argocd/environments/**
          - glob:charts/argocd/**
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: main
  namespace: argocd
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: argocd
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: gitRepo
          value: https://github.com/kdwils/homelab
        - name: targetBranch
          value: main
        - name: warehouse
          value: argocd
      steps:
        - task:
            name: git-ops-clone
            kind: ClusterPromotionTask
        - task:
            name: helm-update-single-chart
            kind: ClusterPromotionTask
          vars:
            - name: chartPath
              value: charts/argocd
            - name: chartRepo
              value: https://argoproj.github.io/argo-helm
            - name: chartName
              value: argo-cd
        - task:
            name: helm-update-single-chart
            kind: ClusterPromotionTask
          vars:
            - name: chartPath
              value: charts/argocd
            - name: chartRepo
              value: https://kdwils.github.io/helm-charts
            - name: chartName
              value: homelab-chart
        - task:
            name: git-ops-commit-pr
            kind: ClusterPromotionTask
          vars:
            - name: commitMessage
              value: |
                Update ArgoCD chart dependencies
            - name: prTitle
              value: "Update ArgoCD chart dependencies"
            - name: prDescription
              value: Update ArgoCD chart dependencies (argo-cd + homelab-chart)
