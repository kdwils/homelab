---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: grpc
      protocol: TCP
      name: grpc
    - port: 8081
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: homelab-envoy-proxy-bouncer
      app.kubernetes.io/instance: envoy-proxy-bouncer
  template:
    metadata:
      labels:
        helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
        app.kubernetes.io/name: homelab-envoy-proxy-bouncer
        app.kubernetes.io/instance: envoy-proxy-bouncer
        app.kubernetes.io/version: "v0.4.3"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: homelab-envoy-proxy-bouncer
      securityContext: {}
      containers:
        - name: homelab-envoy-proxy-bouncer
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          image: "ghcr.io/kdwils/envoy-proxy-bouncer:v0.4.3"
          imagePullPolicy: IfNotPresent
          ports:
            - name: grpc
              containerPort: 8080
              protocol: TCP
            - name: http
              containerPort: 8081
              protocol: TCP
          livenessProbe:
            grpc:
              port: 8080
              service: liveness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            grpc:
              port: 8080
              service: readiness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          env:
            - name: ENVOY_BOUNCER_BOUNCER_APIKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "apiKey"
            - name: ENVOY_BOUNCER_BOUNCER_LAPIURL
              value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
            - name: ENVOY_BOUNCER_BOUNCER_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICS
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICSINTERVAL
              value: "10m"
            - name: ENVOY_BOUNCER_BOUNCER_TICKERINTERVAL
              value: "10s"
            - name: ENVOY_BOUNCER_TRUSTEDPROXIES
              value: "10.43.0.0/16,10.42.0.0/16,74.98.232.127"
            - name: ENVOY_BOUNCER_WAF_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_WAF_APIKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "apiKey"
            - name: ENVOY_BOUNCER_WAF_APPSECURL
              value: "http://crowdsec-appsec-service.crowdsec.svc.cluster.local:7422"
            - name: ENVOY_BOUNCER_CAPTCHA_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_CAPTCHA_PROVIDER
              value: "turnstile"
            - name: ENVOY_BOUNCER_CAPTCHA_SITEKEY
              value: "0x4AAAAAAB1bbQbIpIhvAYwl"
            - name: ENVOY_BOUNCER_CAPTCHA_SECRETKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "secretKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SIGNINGKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "signingKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SESSIONDURATION
              value: "1h"
            - name: ENVOY_BOUNCER_CAPTCHA_TIMEOUT
              value: "10s"
            - name: ENVOY_BOUNCER_CAPTCHA_CALLBACKURL
              value: "https://bouncer.kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_COOKIEDOMAIN
              value: ".kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_SECURECOOKIE
              value: "true"
            - name: ENVOY_BOUNCER_SERVER_GRPCPORT
              value: "8080"
            - name: ENVOY_BOUNCER_SERVER_HTTPPORT
              value: "8081"
            - name: ENVOY_BOUNCER_SERVER_LOGLEVEL
              value: info
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/httproute.yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  parentRefs:
    - name: homelab
      namespace: envoy-gateway-system
  hostnames:
    - "bouncer.kyledev.co"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /captcha
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8080
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/referencegrant.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: homelab-envoy-proxy-bouncer
spec:
  from:
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: argocd
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: blog
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: bluesky
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: mealie
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: media
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: pocketid
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: vaultwarden
  to:
    - group: ""
      kind: Service
      name: homelab-envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab/templates/sealedsecret.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: envoy-bouncer
  namespace: envoy-gateway-system
spec:
  encryptedData:
    apiKey: AgBYzkG1JVpk27rRPq1dgEbGN9LD/11BTQJ8lAmSg5xjL3XiVsmG0ZsJxQDSwVZIFvOKcNW3jGax3Lb8HBg+RJ/1e29Na72MEzHCC7GpIAiU7xmdWbvBxgL+T4ZnfNpKQ5gUfK8jqgavkGdn8NeKrp+QCN3Ft5aXPmDi8OVam2T0zZSEkaeqFlqVwWRvpdaJTNqB6T36HswxD18VuBG3irgTAg4GD52NsTFajfIbzCwuvQDCrgRI/mmTBLSyN20icc7odtTcIAt1BRuaIpm62deDxPS+urP3K55faZcCun7xGUtvJKWB6EvK1VfPYNWuBG6InkWO5Q6Cka4uBsOF/14kkMdP+LX1FNUTE+LL+C0+Gt2pEp0+B61jutnb6buI72sGT2HoPE2W0BXUIPT3P6dCwsfyufEt5x0TvOIyDc+T5E5wyMH8kiXRZkVinAj2T0eUkPvkjrRt8vA70jPZn6hJ5/yDBOrtm6ycyAU1lNT3bDTRLZMO9svgho2VVq7ZKr0FSKSfiYkIULoe1Cyj8ZWUZwHmrQJmBGMsl+wgcgowOxs3hmWmIDyfSR5EGzJGvpjsag7b18ssGadWMKI1wecm9zUCNQW8dk1+Njy9x+ehyNeoFSwI4FlyFsMtE9UzNHDxot3cpwlX5XuV4LE5C+oPA+/atKGXfIjP3vKl8acdrnTIutlG+KzCJgxBc4Mxp6MXBhVHhWbEUpQl+uNPFlkXdc2kXxephdGyTeBxz0HJy12E6M/TtOMsRbyj
    secretKey: AgCeJINVJscNxcGDbOR7kvmlBNc58t8rpqapXQ6EaLuXKv5CmiNfRCKkdX+bmVaWg5Sv5CrvMnxL5RnurRUh2ZyEfmth8PuAmCaDgk5CPrLdr5lr2aChvYpPJETAzK2o3C0LROg7qt2POLv+2B21rP8wH5PEvdKEug9SuBxDGlpNVw0elbado7VFhtIc1meduObkHTEaON7xqsEvREZs3arfbXXcHVVA2MT1NnpXCrIawCAukGLHHqDMB2wtIYKb0K37jPBmGGFEfTIekBw/+XQ+0/1PM+Tn7BOMAxy45iJDsbR+z0ENyW5qR/I/mUQ5DVC2XwQsonJZmX2pwXGhtBBwdIrqEvMi0RYqcVxLRpabjUpQHkzz7EMhRtoyOnHjF1EogzcNZa3tIJkNKC1gNIe1AQJDOtoYifAvQSiBh/9THtLxlW9f5XXQTTC5ArLbJP7m9rukwWP3tSeungMgmpbMjjdB8ODzfu+koDPsKeO7NuuAA76Gsy0+Idhndg68YAaauCDmOYNm+3Ggs/061Yc3NKOHNie9gQ++1PjfVLyaAelLjrJ3sUX7xkKOmSpcwiTVQRkHFNwQ6mbQBEZGbJty2er3A50gcUuWl/CU03/loNypzqnqyCd6z+U1g941YvF/1GAHj1O2oa6p4Sk/azn3kxHmdaI4UlXSUDlr2ndqOZ+s0VzAAcqP67oHH1xw53mKyQPyEr7jUm4WWPkYYxZ8UbneSQPU1NINHIDqSTLdtZElYQ==
    signingKey: AgCU7/yuf85X0dySlJVYUuJzlur9Doc/Aem8luNDCGOMuG2XyqFpv/wbQl5vE3aSTokrH09GezT5grizbXL02+oaSI6A1P+sWL29NYq/NG4iB+xWfsDbfL8Z+CY3kZwsillzNPIpFpUs4uPnVPbcReK/+hW1/TxEYXwMXlDZ+rfTlVaPM8PraAkDrw3qSMI5yTWdsO3d+3YYf1LUPI+zQZ09PpVQUp6mtmkEHp7g9B1qd22juGDS1j0OMMTl+S7u7iub+Q+YaoF2HkDL2K14RG0gjDepqTk2/ogV1JTZK5Jqx9egFMWEifiTyFfGdoi0kmqzilrFv4xJXX4FXjK8qKrtFTVOzhjq8cHuHLDO+owYT89qrlPr1Rt9G9n5C0rp79MvDPOZBEG5wgrnSwrsraL2EM3NoRHtWW6DvGfB1cDdz8udlVnqNa5hViIAqY9gtKWHfNDatE+acHCH9b3baVIJL8cyhNup6yWzGrI8OiU5wCr5zZ4M++lhY9w0tmsClKum9ARuSoQWXsno3onYqmHLS8cYKMIspEU5742qsKcCuOm6HxZeNSCcols1Eswj6V8hAiP7kUp/S7Hql4sKSlNd76zfTleOPL/7MRcLysuCMRCprqU2+ZLQmEVJjCe25joPWbM/Juzj4WpxpQ/vC09GULrHGuoj2IhUIHgtva3J8bnIHpmtD4byG/pfp6Y3aph6GIxRdTG8p0Onzjfn81z3S6zDrscuYT950NNbayFba1VyvF0xx6FlPFigw/zmB/OSX3XEvw/fmuaZWxLYy5Sa
  template:
    type: Opaque
    metadata:
      name: envoy-bouncer
      namespace: envoy-gateway-system
