---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: grpc
      protocol: TCP
      name: grpc
    - port: 8081
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: homelab-envoy-proxy-bouncer
      app.kubernetes.io/instance: envoy-proxy-bouncer
  template:
    metadata:
      labels:
        helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
        app.kubernetes.io/name: homelab-envoy-proxy-bouncer
        app.kubernetes.io/instance: envoy-proxy-bouncer
        app.kubernetes.io/version: "v0.4.3"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: homelab-envoy-proxy-bouncer
      securityContext:
        {}
      containers:
        - name: homelab-envoy-proxy-bouncer
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          image: "ghcr.io/kdwils/envoy-proxy-bouncer:v0.4.3"
          imagePullPolicy: IfNotPresent
          ports:
            - name: grpc
              containerPort: 8080
              protocol: TCP
            - name: http
              containerPort: 8081
              protocol: TCP
          livenessProbe:
            grpc:
              port: 8080
              service: liveness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            grpc:
              port: 8080
              service: readiness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          env:
            - name: ENVOY_BOUNCER_BOUNCER_APIKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "apiKey"
            - name: ENVOY_BOUNCER_BOUNCER_LAPIURL
              value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
            - name: ENVOY_BOUNCER_BOUNCER_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICS
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICSINTERVAL
              value: "10m"
            - name: ENVOY_BOUNCER_BOUNCER_TICKERINTERVAL
              value: "10s"
            - name: ENVOY_BOUNCER_TRUSTEDPROXIES
              value: "10.43.0.0/16,10.42.0.0/16"
            - name: ENVOY_BOUNCER_CAPTCHA_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_CAPTCHA_PROVIDER
              value: "turnstile"
            - name: ENVOY_BOUNCER_CAPTCHA_SITEKEY
              value: "0x4AAAAAAB1bbQbIpIhvAYwl"
            - name: ENVOY_BOUNCER_CAPTCHA_SECRETKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "secretKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SIGNINGKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "signingKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SESSIONDURATION
              value: "3h"
            - name: ENVOY_BOUNCER_CAPTCHA_TIMEOUT
              value: "10s"
            - name: ENVOY_BOUNCER_CAPTCHA_CALLBACKURL
              value: "https://bouncer.kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_COOKIEDOMAIN
              value: ".kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_SECURECOOKIE
              value: "true"
            - name: ENVOY_BOUNCER_SERVER_GRPCPORT
              value: "8080"
            - name: ENVOY_BOUNCER_SERVER_HTTPPORT
              value: "8081"
            - name: ENVOY_BOUNCER_SERVER_LOGLEVEL
              value: info
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/httproute.yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.4.3
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.4.3"
    app.kubernetes.io/managed-by: Helm
spec:
  parentRefs:
    - name: homelab
      namespace: envoy-gateway-system
  hostnames:
    - "bouncer.kyledev.co"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /captcha
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8080
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/referencegrant.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: homelab-envoy-proxy-bouncer
spec:
  from:
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: argocd
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: blog
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: bluesky
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: mealie
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: media
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: pocketid
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: vaultwarden
  to:
  - group: ""
    kind: Service
    name: homelab-envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab/templates/sealedsecret.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: envoy-bouncer
  namespace: envoy-gateway-system
spec:
  encryptedData:
    apiKey: AgA0cTD6XzDKLBlo4cfOO2xydjY7MEbUyjzlzPnPI8S5p7Hvvlxxp++YCb+wgrs457j829KvKojVV2sEMUFAUUafPanynjVifQl2ZzUPvE6zU876gMlM+hq6EkXsKn0NRGhTROdOlYI4LtsfgpclPR+rdwFuSj8mAVEhqjqQ24N3h9loc/oKQX683QXx2dGiA4xUl66QjLxEoIyeINtrLrqsPwqle21Sq1ftm9Yse8zM9KE107gYX2C38cHdryyGjxOoBhZs/I5JEi8YF1NwZnaA5sQ57fP/Zcn/2GkEnVHaLaLIl3KBNhfN4Deka/l59oxXPzLSZxbYPq+rSqKUB24KSm8U5wrsHYiwZq8liXEq6XeWtP4wwX4UzCKFujZSibfz1GoJeZpH0Yv799ZjN8sQmPP59BJyiMm4T278Pe5pj3CqRDhwzCAyGJcmE7f7AkJ3l8aticqRH0gNsqXPcOHFVAgNkyFtr+JOh6W8H88f3jVSGwzRlkakmvU9L1sdS9IZ3p3qy35Y/ECRMiICQJy6BgJO8eaN5iqkBFGHnd+kaVLSE9/9Ja9DTbqHIiGfIiIwboC/qqhf5/iHxNHKJrQZTtALBP1FEahxsDaaL03kiBl/L4PN6Py/Orvw0/X++6LOAPD1F/60UfSeo598SM3mAVyKIMBY7U6OCfaT9BCnS31CVRUTDWr3YXKAMjDqwlTkcg38dYDBpqikb9xz/wgzc35Vhu8HjeOWf3bY9QRx8mmBnGbOnN/deTkF
    secretKey: AgDHVFqlqrcV9lMsQgBiIxevpTQrf4lVVplz7058EpZIrB9y48FGZuc7hPhPAfY8wSQy6S+kVhq26539dyRzIoDJSt+miUIz4O9n8YGaPHNdqYJJiJaf7eCvSCTGDbLGkrephgGdfX9CkkjJL5tqGxSbTgSNiE06WrmsP2pDZOS4wwvDZw77grWWZIFJPb0+V8yJUNf06hjLJwhmGuA5hga41E1er8k/KBYxHGjHhNPBuV4lmehWhUD89P7bBdYvzLnDd4/InDujablmuNuOMzPQ5ppvfCSO5bdhaJn32KWeStgXS2Dg9XPwFNrpKpVAAOACuQ6N5YS+ahG6E5AF70h2n3CHWLHpZjIAd5kheMMMeRgNr3y9ZMFo8Gwv9j4cWNhmzhQKSbJ0znC7mn1pcWipLBHswsjqvslx4dFI36p78PqkA1ri/vHnxlnR1oRZkE5/q9L/AQ/usBn0Yeu1QSKaaeOKHtwXe6HmYlvsU0Byv8BhIYY6qFWkXkL8wqbS2gT8YmRL0oagIqqa/8s8lkyrl7z35o4Q1+mov7e0tV+cT9m8SNp8amRBHotnE03UZTG9mT13la9XCyJKYIecwXStEpk/QSj7DCMWa218ZW/h+yWgHc+b5h+v9Ch3mlGJeANiBaktI72NxpQ0c4WYA7wGMxCfYhoi93cNueEd3zbYU1LhCMDtR6FX+4YYyVIbO96+arNCmKcLp6YzA2O98uPwneS0Fq+N3wCwhI4ok7knia/cSg==
    signingKey: AgBv5eKdrvYKBd2ExrBTDTy/1H9UaBiQGRGydgsc/2Dm9Mm6R2FHhkk8HLD+7sOWN6LnbngXIoe4Y49CR1uRX3xrzMfZKxvViqFMOHIVCmeFe3w7szlOciVloo1GgHjERKfyI2YTzsNH6xwCAjrPhhYYPfys5VH+KdXg7XNnpmvpLrPnZFulJd0CIwOUF78MGaVlg7VCsodBcDKg0gkkkpOM/UCfsJTTsLQMyi0TxFhGwVsKa7WLdYpr50jlLnQetO9s8mPuFaniHdfuNxbjHUyPXhefh6W/naqFV0b8+XhZppd/zhUhLgmnPRwE+ebdegoq1cynxiV0+D18vJ0/yvQjnZP+QNK6qsxcUXxz8id00pF7ubx9E3+owUizJ0mQJHjVbyUqFvFXSdT5RqBf4Rw3aUET1RIXiLiLZryz++Sb8sGKdrhiy6sBpekww4E5rqPtCAqAcNIEk7jC3Ez4eUuBJgVF0jqFT2kQKrunZFqvwMN/ph03KDe+iEoIF1P6pHTyfucrnaDzHWA86F4PUBVJCZc9lZ/zQMt19ENFzfHN3Lplwjd50WI7JQ1QvNmCmYfoCO9KlHZ33WoQoR7bVHpGuW5VflXqd5ocFX8h94ZkvP9keEHT4b1cGHvDswDYC/szYV4zUcMc77UxlRZedyAECMgBeVk6dqrcIaBbMpcDPZQiKzC9Gz9xhDm+VdouZnPp+IXQkcTPP7CgP+/RMGvvGsViwEhjLz7bitx1T/68aNsD0KgKi20JR/owtlkx/rGefMwaBRxnEzLzXn50yF/6
  template:
    type: Opaque
    metadata:
      name: envoy-bouncer
      namespace: envoy-gateway-system
