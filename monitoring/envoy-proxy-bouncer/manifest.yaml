---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: grpc
      protocol: TCP
      name: grpc
    - port: 8081
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: homelab-envoy-proxy-bouncer
      app.kubernetes.io/instance: envoy-proxy-bouncer
  template:
    metadata:
      labels:
        helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
        app.kubernetes.io/name: homelab-envoy-proxy-bouncer
        app.kubernetes.io/instance: envoy-proxy-bouncer
        app.kubernetes.io/version: "v0.5.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: homelab-envoy-proxy-bouncer
      securityContext:
        {}
      containers:
        - name: homelab-envoy-proxy-bouncer
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          image: "ghcr.io/kdwils/envoy-proxy-bouncer:v0.5.0"
          imagePullPolicy: IfNotPresent
          ports:
            - name: grpc
              containerPort: 8080
              protocol: TCP
            - name: http
              containerPort: 8081
              protocol: TCP
          livenessProbe:
            grpc:
              port: 8080
              service: liveness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            grpc:
              port: 8080
              service: readiness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          env:
            - name: ENVOY_BOUNCER_BOUNCER_APIKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "apiKey"
            - name: ENVOY_BOUNCER_BOUNCER_LAPIURL
              value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
            - name: ENVOY_BOUNCER_BOUNCER_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICS
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICSINTERVAL
              value: "10m"
            - name: ENVOY_BOUNCER_BOUNCER_TICKERINTERVAL
              value: "10s"
            - name: ENVOY_BOUNCER_TRUSTEDPROXIES
              value: "10.43.0.0/16,10.42.0.0/16"
            - name: ENVOY_BOUNCER_CAPTCHA_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_CAPTCHA_PROVIDER
              value: "turnstile"
            - name: ENVOY_BOUNCER_CAPTCHA_SITEKEY
              value: "0x4AAAAAAB1bbQbIpIhvAYwl"
            - name: ENVOY_BOUNCER_CAPTCHA_SECRETKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "secretKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SIGNINGKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "signingKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SESSIONDURATION
              value: "3h"
            - name: ENVOY_BOUNCER_CAPTCHA_TIMEOUT
              value: "10s"
            - name: ENVOY_BOUNCER_CAPTCHA_CALLBACKURL
              value: "https://bouncer.kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_COOKIEDOMAIN
              value: ".kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_SECURECOOKIE
              value: "true"
            - name: ENVOY_BOUNCER_SERVER_GRPCPORT
              value: "8080"
            - name: ENVOY_BOUNCER_SERVER_HTTPPORT
              value: "8081"
            - name: ENVOY_BOUNCER_SERVER_LOGLEVEL
              value: info
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/httproute.yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  parentRefs:
    - name: homelab
      namespace: envoy-gateway-system
  hostnames:
    - "bouncer.kyledev.co"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /captcha
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8080
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/referencegrant.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: homelab-envoy-proxy-bouncer
spec:
  from:
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: argocd
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: blog
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: bluesky
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: mealie
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: media
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: pocketid
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: vaultwarden
  to:
  - group: ""
    kind: Service
    name: homelab-envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab/templates/sealedsecret.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: envoy-bouncer
  namespace: envoy-gateway-system
spec:
  encryptedData:
    apiKey: AgCqQ0JyZNJVMklA21uU6MWqpnvAZz8VWqbp4G0syCqg6ZqN6O7NHTn5PSy9iHUuAPUNyySW/V1RIEaE/GbGedV/iiWXVYBidPOp1hbaW5ku6HXuZ6n++sWgCWNo2/KVhU3zveWQUocp2njtCfCL3kFQ2zvjYR6Nq1TyhXUyYwvucjX5Ad7p3SiPl7uFUMJAQWjLske1apYYpBZkutKK1IZHNBHq3KGmpKalir8kbZJsgbDeCc0RYyFBoYmygtU0W8ND9ioUoE+9brbxV6AMe5mnmSuuq9lEEQgrEMiISAHHTyUH3oknG8tgjlUel0AmoV7FyMpC937M9FIz5AL+1eTWdRIrEnWWLaVCBQcrNQYt4qZOTSXrBeKVgCNHCPOS0JmeKNmzLKxbNit/pTq8wfKCJlSVGwOpvkNCkWkKbR8WOW7rSF6nZFmXSLRkPSNoTlPLgU4B3xcv53Wkrn3pusCe0G9HAnBAj7InI87SwKV/jH8SueygGjwmgEJdMgjd4V4hjQYjTQtyqh0Ybgl1R1Eb1d/+0xvOGvO/bpcVroWHt9FtCEksRLPgiwgB9RrNsx+MfvcAKcir3MUZxmE9KQxVueudo44fyNFwxj3RPBSdEN4xpTS662nq612qdearM1fb3pN+URJY3g4NImEcWC4zQy8Jc04NCZt2AuS2nmRNArFPfpmBletz9mboS/K/xqGtKiEdLlkL3xFlCimTxQ2dui1leEXxSPdI7govvPuEBhShR2TxjMUa5CeR
    secretKey: AgBplKIRggchAGq7TXUO2Q7duARHLrdwlhzhMizjf5JnMgJEB1h4DSx1SXjMNakF97FTv/33EH6e6hPHq/ZqgqpCvdrglPJ3V7ObLWd1BOov3hNTO3cpdHVil+8iz808TKFeOGRFrjPsspLTqAJ9wvDbMv33f077xwpwM9Jb7Ts508SeZ0PgJxSS5dbHf8ochPl1coXAZqiEQzOgl0zrlB2UePv01L/9nKqrghJOdbz1Z1W/5tLtOZ/oW754g0YpJSlq0/CSiBZQL7JzHtxJcYjIv3t6xT8GDu/10IZYKGgKBJXFl5IL64IqlGTRD6bi2WLQyqgG6sSifBKSx2wDMdzv5VJ9pRTk8BpKqDgPGN0o+18Uj6xQLUlbSsvk7dQdzElxTF84YOJ/Ss+QIyL1g97rjYhEqU2kChtuBI63Zv/CGnmc4jVPqHSHX0HPU2A6I1nU/K/w7r0BL2TtSAUvn+kxcIEfcFFBBr88abAfImbtrb0zrSa7rhNySD5gApFQqG8UhlnKsHac/RzzM5F2aFHhp/WkLMO7CQ6/kdFS+XL+tKDfnPbgxa1I27BXL5wvD+thvDxdl/wllKFYzBdX4vedNQjBH6Cy03vBb3f/gdB8QnFZ8/h1MiQU6BrOCj/xni4tTCGMpgwbw+kunngxOAidFw+EFZ9qaWeQQ0+ecCuS0MoDwt0VY+CRNGmepyvMFyHwOljF2fzkEADM7ODCY/5ZWN6TPJTo2I0CeG4bUa6xkUabbw==
    signingKey: AgAcwA41UOd/UsIJU1B/g9fViYDtxXH2lPGtl8l/OXSn8PIT3IADenR8tsKb1YDKpKe04EiUAqK5tDh8P7gtYBCc0EnBoq0K5gPBAU7VQquSnp5mfUNQQpe0sKnKeLQDcwGvlw2aDFeF0+bq0P77X3/+G5DWcGzMdv3XcMiohhxEtro1UjcsA+66pWtw224qZ8s4XMtqnT8AhZIrqVi50s+UJbO6vaXvg2kuwyHZO0AdQIuZXssIq8+obhm82McGbm49gCVhs35O98Zp/VU8tKnUo75jaitnsyDdvBh3l5KaFGLlv9A542+DuIQd6lOyJOeZKJBPguA8MqsrsKQ7oIDWJ2UKdRfjKh+2X3oYmaeQyNrQ+uUJG8FlzqqfRGZaQ+sybE/RBIQGp9q+ZmRCI+G+Fh6NxtJRka22BTBuBOiGex1iMGTkXRrsY2Tqr14bgJZhDYVcTMtRFLO50P2aQZeg0Du/cUpZR5Jm/EVaOdXpqDSxTDXwYrJrpvvQk7lsAImWa3QjcegaBgnB22qdMJ6wchS625CJfZ4AYmUMt2aMWALyyrCaSMmZeth+SEVZ36RykMjCJ2D8mZCWUzruJ4Psw1bG8blG0UCgpOAlKC47pCKfjmle9DTbwNu3pMh/HmSsyFeBQdyTL+FDuJXFITbz44GRSuvvy1hrc1f0Up+coidJ+NX6BYJ2B3LrvRFVGkmbA4FCDoIjBPgcwruhM9B2F7kk9V/5op7RT5WW5/jW0kLaF38Rz5r8VOPG2NVILPoWVQeFh0fmWEFKr99kbU9T
  template:
    type: Opaque
    metadata:
      name: envoy-bouncer
      namespace: envoy-gateway-system
