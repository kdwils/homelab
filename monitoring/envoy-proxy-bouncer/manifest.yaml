---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: grpc
      protocol: TCP
      name: grpc
    - port: 8081
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: homelab-envoy-proxy-bouncer
      app.kubernetes.io/instance: envoy-proxy-bouncer
  template:
    metadata:
      labels:
        helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
        app.kubernetes.io/name: homelab-envoy-proxy-bouncer
        app.kubernetes.io/instance: envoy-proxy-bouncer
        app.kubernetes.io/version: "v0.5.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: homelab-envoy-proxy-bouncer
      securityContext:
        {}
      containers:
        - name: homelab-envoy-proxy-bouncer
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - all
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          image: "ghcr.io/kdwils/envoy-proxy-bouncer:v0.5.0"
          imagePullPolicy: IfNotPresent
          ports:
            - name: grpc
              containerPort: 8080
              protocol: TCP
            - name: http
              containerPort: 8081
              protocol: TCP
          livenessProbe:
            grpc:
              port: 8080
              service: liveness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            grpc:
              port: 8080
              service: readiness
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          env:
            - name: ENVOY_BOUNCER_BOUNCER_APIKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "apiKey"
            - name: ENVOY_BOUNCER_BOUNCER_LAPIURL
              value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
            - name: ENVOY_BOUNCER_BOUNCER_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICS
              value: "true"
            - name: ENVOY_BOUNCER_BOUNCER_METRICSINTERVAL
              value: "10m"
            - name: ENVOY_BOUNCER_BOUNCER_TICKERINTERVAL
              value: "10s"
            - name: ENVOY_BOUNCER_TRUSTEDPROXIES
              value: "10.43.0.0/16,10.42.0.0/16"
            - name: ENVOY_BOUNCER_CAPTCHA_ENABLED
              value: "true"
            - name: ENVOY_BOUNCER_CAPTCHA_PROVIDER
              value: "turnstile"
            - name: ENVOY_BOUNCER_CAPTCHA_SITEKEY
              value: "0x4AAAAAAB1bbQbIpIhvAYwl"
            - name: ENVOY_BOUNCER_CAPTCHA_SECRETKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "secretKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SIGNINGKEY
              valueFrom:
                secretKeyRef:
                  name: "envoy-bouncer"
                  key: "signingKey"
            - name: ENVOY_BOUNCER_CAPTCHA_SESSIONDURATION
              value: "3h"
            - name: ENVOY_BOUNCER_CAPTCHA_TIMEOUT
              value: "10s"
            - name: ENVOY_BOUNCER_CAPTCHA_CALLBACKURL
              value: "https://bouncer.kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_COOKIEDOMAIN
              value: ".kyledev.co"
            - name: ENVOY_BOUNCER_CAPTCHA_SECURECOOKIE
              value: "true"
            - name: ENVOY_BOUNCER_SERVER_GRPCPORT
              value: "8080"
            - name: ENVOY_BOUNCER_SERVER_HTTPPORT
              value: "8081"
            - name: ENVOY_BOUNCER_SERVER_LOGLEVEL
              value: debug
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/httproute.yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homelab-envoy-proxy-bouncer
  labels:
    helm.sh/chart: homelab-envoy-proxy-bouncer-0.5.0
    app.kubernetes.io/name: homelab-envoy-proxy-bouncer
    app.kubernetes.io/instance: envoy-proxy-bouncer
    app.kubernetes.io/version: "v0.5.0"
    app.kubernetes.io/managed-by: Helm
spec:
  parentRefs:
    - name: homelab
      namespace: envoy-gateway-system
  hostnames:
    - "bouncer.kyledev.co"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /captcha
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: homelab-envoy-proxy-bouncer
          port: 8080
---
# Source: envoy-proxy-bouncer/charts/homelab-envoy-proxy-bouncer/templates/referencegrant.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: homelab-envoy-proxy-bouncer
spec:
  from:
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: argocd
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: blog
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: bluesky
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: mealie
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: media
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: pocketid
  - group: gateway.envoyproxy.io
    kind: SecurityPolicy
    namespace: vaultwarden
  to:
  - group: ""
    kind: Service
    name: homelab-envoy-proxy-bouncer
---
# Source: envoy-proxy-bouncer/charts/homelab/templates/sealedsecret.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: envoy-bouncer
  namespace: envoy-gateway-system
spec:
  encryptedData:
    apiKey: AgBm1id9U0LhjYWfF5t8xfyg1QYza+OKsNlaaYLcquO3F+2t+v9nvwQ2lT2A5ngsMWL5p2jVJV92GHar2h4s8ru0SseoWcm9WKW0T5xSEz5aTALlH026XCsCialt7waEvQ8/L743PusqAd65bVRPxvR9t6iiE9dObUvKwRrk08YhgUw87TZjJiZp67VuL+7KGDRKDlFrMcTBth+YQ2FM/ot1VsHHBKIcsawdCLhzoNYgw/xYT0B8GzcdyuJHsdFGwUyI3RtSlsEmm6Jum/Dc54kBoZFLTAh4UqANR8ZqocAKQTNMPVbW9f8mkGud5KdwjfbcqsrcGBR23upmTjvkYOnEkkRGjhjn1I9pFBMKw0awSgYWWp4Q+sYEr6bsadasjWFGom+caIPZxD8JGUpu0qx5a56NVUBmevW1iZCc8oBYmUyNpqNMsJAICfpQzreFJmQHxkuNNnthMnNm3vptukH5eu2wwLd+crmbrL2hwVJ1MzSi2xgQLbjSWsRyvb1zYnEsrCiY9mk15GYFtkLCQQD1izFnDBf3I1+o7Bzksi4m8lx0pUgYxyFBMlpdICDaPFT/PzBLQNl4DNyig34oTAQB/UPx/0JNnvYLYqWvL39kS8uhWu0gYuiOLaF6yZve27LAEPSUbxJ5QiulZhbLRBbncI/7H0rSwPUFguWnL+dsIWqPwKhyQc6CoEROiTyWLaPddm5nt9wgB/ks0nVlA9zGAW/cUnPqHVLrRYHGWp8utZPrJCaGIRq6pRHb
    secretKey: AgB8BJYD84hdEOXJVg693tQBAj87BJ826fwD1hSwNh+Cd786lYH6XkewvHmACvqYY/+J2GHKNZRUDuykkstnIkoBk+XKkotUvr8PMSZnnmNO7VwwsIj1HnFBQwutTVSjMn5iVXjqcvOgYXnjJlTw1G9NfJYvmRUNPZeOW6sBHv1My8787BSBuch8VqJrmW0B3LD+hVsQDBUUiTd1F0Bx2Uh9R/RVJQl7rU4fnSqQQvbmuk4vPkVRJuz/DHl0RzBatlkR9OuBb5kfSyIlN39dXsGrhANXt/PAkWBxhR6hApUhWNMRN4FMPELrTft1cjTCBwUzhFZ0GgzqWI5kMYoOYS7lZc5M+FGkF66YZKWlY6DAis7scFn3My/MlgLhqO5+uVmwU1mSmQpV3IKDlDUuJ73NEUYswexYi9orpQ76Mej211e4rEMa7lAXQxX4cDvar3/qBKoYga6qoUBhbiFFt09pbocrh2LXVRop3Z2Fuk4PxCtNxN3FaZ3dU+rw5ZvHR4Uv7mIljrxxZtBLDQAmDNHch1/FEruQzvYVwX1id1orsYlXDHQiOTYU/r8BAxZEg1Ti24WJMuptgXXZt+j3rC5meqkxIWOpIxAigsCgPO8dCR29c67kOFNdArTmC0fl2TePBLSPZ9Lw/v8DnSBk5Nixh4cQeUxsIqA6HCcwc+JFv6K2gmwoGY9RyCzlAe4ntDXrm3oR02yzeP+t8hs2Gc3AwYpxt0fZkUO75fxE1Y66AuU/LA==
    signingKey: AgC3rRowRiP52X3JmOEUjKAIcpGxKbBDlJmgzEKAvOEuHFLZW8rzzT2MK2MCwoyxEFhLsGdgCMzW8DhTJr9m6EBErutnn0pjXO+5dxI7QH8BiwlMaTD+1RGROwiHh1yJx1QGh32QE/FmM9SEkt6EBlKi4sJ1ALxORfuGuB/QT2nqPplywl1ZAb+2Chl4Lco6KI/rXXcb0JNMb5gHv2WSeXwJxIfLdSuVz3xX0PrpyBZ5e3zSnR2bnNgk7q0xIVYP7Tad0fpTso+B+cFRj94/iqgzap2xglBeOkfsEl//8sHbwSC0OBQ6oUl0s9ZCA8xErjrc961nuvh/B53GdhA/h5xuMhRmTS2JTpb8fuBdzuEYWn0cLmH+qOG61IZNt77QXg2H4U0kDYfCQUBY7XvUv790rCWXVnJGqrD/93TkMOSclADNlodqVI3xsXAkHUakqFEDxL0lUHZ0SgOofDqquTe4zitDSrmoAsCpIKxoTtJJajiN/HoFXLlny5MQmYosD0DNS38ZqkvZ0ydN9zAiBUPfzdAetOL2FyNo0ylCPmlkFrsRCbghXiZfHUw5tbl+zHencK7kYZhZT0/xbxCZOsRn7VMQvDEyu0HMsfmIETujICan2USBTmgYQrf2U5Z4pi5j5KK1ZIVGw2lQMXe6wpgVy2Ny7asz8wGLBoyKQ7EV8VSbalDaKaRax8CBgDCIZKl41rHASH+Pz2QKFsD15QDo/cL6ygfIA+yiArNNf9B6o9tKeHiPPfl3fxqb+qR+xb7kdx723CnOYLHa/8ISD2EZ
  template:
    type: Opaque
    metadata:
      name: envoy-bouncer
      namespace: envoy-gateway-system
