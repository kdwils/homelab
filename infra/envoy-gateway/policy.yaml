apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: envoy-bouncer-policy
  namespace: envoy-gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: homelab
  extAuth:
    grpc:
      backendRefs:
        - group: ""
          kind: Service
          name: envoy-bouncer
          port: 8080
          namespace: envoy-gateway-system
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: ClientTrafficPolicy
metadata:
  name: ip-detection
  namespace: envoy-gateway-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: homelab
  clientIPDetection:
    xForwardedFor:
      trustedCIDRs:
        - 10.42.0.0/16
        - 10.43.0.0/16
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: access-log-format
  namespace: envoy-gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: homelab
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      name: envoy-gateway-system/homelab/http
      operation:
        op: replace
        path: "/access_log/0/typed_config/json_format"
        value:
          ":authority": "%REQ(:AUTHORITY)%"
          bytes_received: "%BYTES_RECEIVED%"
          bytes_sent: "%BYTES_SENT%"
          client_ip: "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%"
          connection_termination_details: "%CONNECTION_TERMINATION_DETAILS%"
          downstream_local_address: "%DOWNSTREAM_LOCAL_ADDRESS%"
          downstream_remote_address: "%DOWNSTREAM_REMOTE_ADDRESS%"
          duration: "%DURATION%"
          method: "%REQ(:METHOD)%"
          protocol: "%PROTOCOL%"
          requested_server_name: "%REQUESTED_SERVER_NAME%"
          response_code: "%RESPONSE_CODE%"
          response_code_details: "%RESPONSE_CODE_DETAILS%"
          response_flags: "%RESPONSE_FLAGS%"
          route_name: "%ROUTE_NAME%"
          start_time: "%START_TIME%"
          upstream_cluster: "%UPSTREAM_CLUSTER%"
          upstream_host: "%UPSTREAM_HOST%"
          upstream_local_address: "%UPSTREAM_LOCAL_ADDRESS%"
          upstream_transport_failure_reason: "%UPSTREAM_TRANSPORT_FAILURE_REASON%"
          "user-agent": "%REQ(USER-AGENT)%"
          "x-envoy-origin-path": "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
          "x-envoy-upstream-service-time": "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
          "x-forwarded-for": "%REQ(X-FORWARDED-FOR)%"
          "x-request-id": "%REQ(X-REQUEST-ID)%"
