apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: bouncer-cluster
  namespace: envoy-gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: homelab
  patches:
    - type: MERGE
      match:
        context: LISTENER
      value:
        filter_chains:
          - filters:
              - name: envoy.filters.http.ext_authz
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                  transport_api_version: V3
                  grpc_service:
                    envoy_grpc:
                      cluster_name: envoy-bouncer
                      authority: envoy-bouncer.envoy-gateway-system.svc.cluster.local
                    timeout: 0.25s
    - type: MERGE
      match:
        context: GATEWAY
      value:
        static_resources:
          clusters:
            - name: envoy-bouncer
              connect_timeout: 0.25s
              type: STRICT_DNS
              typed_extension_protocol_options:
                envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
                  "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
                  explicit_http_config:
                    http2_protocol_options: {}
              load_assignment:
                cluster_name: envoy-bouncer
                endpoints:
                  - lb_endpoints:
                      - endpoint:
                          address:
                            socket_address:
                              address: envoy-bouncer.envoy-gateway-system.svc.cluster.local
                              port_value: 8080
